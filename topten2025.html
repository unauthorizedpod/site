<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Gallery | Some Like It Unauthorized</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries for Zipping files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@600;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Manrope', sans-serif;
            padding: 20px;
        }

        /* Controls Area */
        #controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-btn {
            background-color: #a78bfa;
            color: #050505;
            font-weight: 800;
            padding: 10px 20px;
            border-radius: 9999px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            background-color: #c4b5fd;
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
            transform: none;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 4px;
        }

        .film-square {
            position: relative;
            aspect-ratio: 1 / 1;
            overflow: hidden;
            background-color: #1a1a1a;
            cursor: pointer; /* Indicates clickable for download */
        }

        /* Visual representation (HTML/CSS layer) */
        .visual-layer img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0.8;
        }

        .film-square:hover .visual-layer img {
            transform: scale(1.05);
            opacity: 0.5;
        }

        .visual-layer .film-title {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            background: rgba(0,0,0,0.2);
            pointer-events: none;
            transition: background 0.3s;
        }

        .film-square:hover .visual-layer .film-title {
            background: rgba(0,0,0,0.6);
        }

        .title-text {
            font-weight: 800;
            font-size: 1.1rem;
            line-height: 1.2;
            text-transform: uppercase;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            letter-spacing: 0.05em;
        }

        /* Download overlay icon */
        .download-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            padding: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }
        .film-square:hover .download-icon {
            opacity: 1;
        }

        #status-msg {
            color: #9ca3af;
            font-size: 0.9rem;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div id="controls">
        <button id="download-zip-btn" class="action-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            Download All (ZIP)
        </button>
        <span id="status-msg"></span>
    </div>

    <div id="gallery" class="gallery-grid"></div>

    <script>
        const apiKey = "746e663319009236f390938e29383ae0";
        const gallery = document.getElementById('gallery');
        const downloadBtn = document.getElementById('download-zip-btn');
        const statusMsg = document.getElementById('status-msg');

        // Cache found image URLs so we don't re-fetch for the zip
        const imageCache = {};

        const films = [
            "Halloween", "Behindert", "Vengeance Is Mine", "Throw Away Your Books, Rally in the Streets", 
            "Two-Lane Blacktop", "Perfect Blue", "Underground", "Miller's Crossing", "Fargo", 
            "Naked", "Secrets & Lies", "The Travelling Players", "Eternity and a Day", 
            "Landscape in the Mist", "Raise the Red Lantern", "The Company of Strangers", 
            "All the President's Men", "Autumn Sonata", "Incendies", "Mishima: A Life in Four Chapters", 
            "Memories of Murder", "The Pianist", "The Killing of a Chinese Bookie", "Nobody Knows", 
            "Life Is Beautiful", "Farewell My Concubine", "An Elephant Sitting Still", "A Special Day", 
            "Das Boot", "Dersu Uzala", "Akira", "Life, and Nothing More…", "Malcolm X", "Cure", 
            "The Lovers on the Bridge", "A Moment of Innocence", "Poetry", "Streetwise", 
            "The Emperor's Naked Army Marches On", "Crumb", "Manila in the Claws of Light", 
            "Nowhere", "Safe", "Exotica", "The Cook, the Thief, His Wife & Her Lover", 
            "In the Realm of the Senses", "Southern Comfort", "Beautiful Thing", "Show Me Love", 
            "Eating Raoul", "Y Tu Mamá También", "La Cérémonie", "Day for Night", 
            "The Long Goodbye", "Ms .45", "Pastoral: To Die in the Country", "Jodorowsky's Dune", 
            "Eureka", "The New Land", "Songs from the Second Floor", "Ritual", "Lilya 4-ever", 
            "Maborosi", "Portrait of a Young Girl at the End of the 60s in Brussels", "Peppermint Candy", 
            "Happy Hour", "The Life of Jesus", "Motorama", "El Norte", "The Holy Innocents", 
            "Ganja & Hess", "Colossal Youth", "Hard to Be a God", "Death of Yazdgerd", "Nayakan", 
            "Comrades, Almost a Love Story", "Dead Man's Letters", "Twelve Monkeys", "JFK", 
            "Man of Marble", "The World According to Garp", "Flesh for Frankenstein", "Breaking the Waves"
        ];

        async function fetchImage(title) {
            if (title === "Underground") {
                // Specific ID for Underground (1995) to avoid conflict
                try {
                    const response = await fetch(`https://api.themoviedb.org/3/movie/11902?api_key=${apiKey}`);
                    const data = await response.json();
                    if (data.poster_path) return `https://image.tmdb.org/t/p/w500${data.poster_path}`;
                    if (data.backdrop_path) return `https://image.tmdb.org/t/p/w780${data.backdrop_path}`;
                    return null;
                } catch { return null; }
            }

            try {
                let query = title;
                let year = null;
                if (title === "Halloween") year = 1978;
                if (title === "Malcolm X") year = 1992;
                
                let url = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(query)}`;
                if (year) url += `&year=${year}`;

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const match = data.results[0];
                    if (match.poster_path) return `https://image.tmdb.org/t/p/w500${match.poster_path}`;
                    if (match.backdrop_path) return `https://image.tmdb.org/t/p/w780${match.backdrop_path}`;
                }
                return null;
            } catch (e) {
                console.error(e);
                return null;
            }
        }

        // Creates a Blob (image file) where the text is permanently drawn onto the image
        async function createCompositeBlob(title, imageUrl) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 600; // Resolution of downloaded image
                canvas.width = size;
                canvas.height = size;

                // Load image
                const img = new Image();
                img.crossOrigin = "anonymous"; // Essential for manipulating external images
                img.src = imageUrl;

                img.onload = () => {
                    // 1. Draw Image (Object-fit: cover logic)
                    let sWidth = img.width;
                    let sHeight = img.height;
                    let sX = 0;
                    let sY = 0;
                    const aspect = sWidth / sHeight;
                    
                    if (aspect > 1) { // Landscape source
                        sWidth = sHeight; // Crop center square
                        sX = (img.width - sWidth) / 2;
                    } else { // Portrait source
                        sHeight = sWidth;
                        sY = (img.height - sHeight) / 2;
                    }
                    
                    // Draw slightly dimmed image
                    ctx.fillStyle = "#000";
                    ctx.fillRect(0,0,size,size);
                    ctx.globalAlpha = 0.8; // Match CSS opacity
                    ctx.drawImage(img, sX, sY, sWidth, sHeight, 0, 0, size, size);
                    ctx.globalAlpha = 1.0;

                    // 2. Draw Text Overlay Background
                    // Gradient at bottom for readability
                    const gradient = ctx.createLinearGradient(0, size, 0, 0);
                    gradient.addColorStop(0, "rgba(0,0,0,0.9)");
                    gradient.addColorStop(0.4, "rgba(0,0,0,0.5)");
                    gradient.addColorStop(1, "rgba(0,0,0,0.1)");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, size, size);

                    // 3. Draw Text
                    ctx.fillStyle = "white";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    // Try to match font roughly
                    ctx.font = "800 50px sans-serif"; 
                    
                    // Simple word wrap logic
                    const words = title.toUpperCase().split(' ');
                    let line = '';
                    let lines = [];
                    const maxWidth = size - 60; // Padding
                    
                    for(let n = 0; n < words.length; n++) {
                        let testLine = line + words[n] + ' ';
                        let metrics = ctx.measureText(testLine);
                        let testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            lines.push(line);
                            line = words[n] + ' ';
                        } else {
                            line = testLine;
                        }
                    }
                    lines.push(line);

                    // Center text vertically
                    const lineHeight = 60;
                    const totalTextHeight = lines.length * lineHeight;
                    let startY = (size / 2) - (totalTextHeight / 2) + (lineHeight/2);

                    // Add shadow for pop
                    ctx.shadowColor = "rgba(0,0,0,0.9)";
                    ctx.shadowBlur = 15;
                    ctx.shadowOffsetY = 4;

                    for (let i = 0; i < lines.length; i++) {
                        ctx.fillText(lines[i], size/2, startY + (i * lineHeight));
                    }

                    // Export
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.9);
                };

                img.onerror = (err) => {
                    console.error("Failed to load image for canvas", title);
                    resolve(null); // Resolve null to skip without crashing
                };
            });
        }

        async function createGalleryItem(title) {
            const div = document.createElement('div');
            div.className = 'film-square';
            div.onclick = () => downloadSingleImage(title);
            div.title = "Click to download image";
            
            // Initial placeholder HTML
            div.innerHTML = `
                <div class="visual-layer w-full h-full relative">
                    <div class="w-full h-full bg-gray-900 flex items-center justify-center"></div>
                    <div class="film-title"><span class="title-text">${title}</span></div>
                </div>
                <div class="download-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                </div>
            `;
            gallery.appendChild(div);

            const imageUrl = await fetchImage(title);
            
            if (imageUrl) {
                // Store in cache for the zipper
                imageCache[title] = imageUrl;

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = title;
                img.loading = "lazy";
                img.crossOrigin = "anonymous"; // Important for canvas later
                div.querySelector('.visual-layer div:first-child').replaceWith(img);
            }
        }

        // --- Download Logic ---

        async function downloadSingleImage(title) {
            const url = imageCache[title];
            if (!url) {
                alert("Image not found or loading...");
                return;
            }
            
            statusMsg.textContent = `Generating ${title}...`;
            const blob = await createCompositeBlob(title, url);
            if (blob) {
                saveAs(blob, `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`);
                statusMsg.textContent = "";
            } else {
                statusMsg.textContent = "Error generating image.";
            }
        }

        downloadBtn.addEventListener('click', async () => {
            const zip = new JSZip();
            let count = 0;
            const total = films.length;
            
            downloadBtn.disabled = true;
            statusMsg.textContent = `Starting... 0/${total}`;

            // We process sequentially to avoid nuking the browser/network
            for (const title of films) {
                const url = imageCache[title];
                
                if (url) {
                    const blob = await createCompositeBlob(title, url);
                    if (blob) {
                        const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`;
                        zip.file(filename, blob);
                    }
                }
                
                count++;
                statusMsg.textContent = `Processing... ${count}/${total}`;
            }

            statusMsg.textContent = "Zipping files...";
            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "unauthorized_films.zip");
                statusMsg.textContent = "Done!";
                downloadBtn.disabled = false;
            });
        });

        // Initialize display
        films.forEach(title => createGalleryItem(title));

    </script>
</body>
</html>
